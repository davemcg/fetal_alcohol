---
title: Reanalysis of DNA methylation analyses in archived newborn bloodspots reveal
  signals associated with fetal alcohol syndrome, maternal smoking, gender, and ethnicity
author: "David McGaughey"
date: "July 7, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Note

In recognition of the rapid pace of analytical tools and approaches to EWAS and Illumina 450k arrays, we conducted an analysis of our dataset guided by the recommendations of Maksimovic et al. (http://f1000research.com/articles/5-1281/v1). This Rmarkdown document contains the full code used to generate the plots and tables presented. 

```{r}
# package loading
library(data.table)
library(dplyr)
library(limma)
library(minfi)
library(IlluminaHumanMethylation450kanno.ilmn12.hg19)
library(IlluminaHumanMethylation450kmanifest)
library(RColorBrewer)
library(missMethyl)
library(matrixStats)
library(Gviz)
library(DMRcate)
library(stringr)
library(data.table)
library(dplyr)

sessionInfo()
```

## Pull in annotation, metadata, and raw Illumina 450k data from the idat files

```{r}
# pull annotation
ann450k <-  getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)

# bring in raw data (Illumina .idat)
# data and code available at:
#   https://github.com/davemcg/fetal_alcohol
#   GSE65428
metadata <- fread('~/git/fetal_alcohol/sentrix_id_conversion_table_demographics_v6.txt')
targets <- read.metharray.sheet("/Volumes/ThunderBay/PROJECTS/brody/fetal_alcohol/Tsai_Sample_083/",pattern="Sheet.csv$")
rgSet <- read.metharray.exp(targets=targets)
sampleNames(rgSet) <- rgSet$Sample_Name

# add sample group info to targets, fewer rows in metadata, already parsed down to remove outliers
targets <- left_join(data.frame(metadata),targets,by=c("Sample"="Sample_Name"))
targets$Sample_Group <- targets$Case.Control
targets$Sample_Name <- targets$Sample

# remove samples based on previous outlier analysis / ethnicity (see Methods of "DNA methylation analyses in archived newborn bloodspots reveal signals associated with fetal alcohol syndrome, maternal smoking, gender, and ethnicity")
keep <-  rgSet$Sample_Name %in% targets$Sample_Name
rgSet <- rgSet[,keep]

# calculate the detection p-values for poorly performing 450k probes
detP <- detectionP(rgSet)
head(detP)

```

## Check samples for high amounts of poorly performing sites 

Generally we want well under 5% of sites failing. Error rates for our data are very low.

```{r}
# plot detection p-values
# everything looks fine in this data-set
# first match up targets to detP
targets <- targets[match(colnames(detP), targets$Sample),]

pal <- brewer.pal(8,"Dark2")
par(mfrow=c(1,2))
barplot(colMeans(detP), col=pal[factor(targets$Sample_Group)], las=2,
        cex.names=0.8, ylab="Mean detection p-values")
abline(h=0.05,col="red")
legend("topleft", legend=levels(factor(targets$Sample_Group)), fill=pal,
       bg="white")

barplot(colMeans(detP), col=pal[factor(targets$Sample_Group)], las=2,
        cex.names=0.8, ylim=c(0,0.002), ylab="Mean detection p-values")
abline(h=0.05,col="red")
legend("topleft", legend=levels(factor(targets$Sample_Group)), fill=pal,
       bg="white")

```


## Normalize data with preprocessQuantile and plot differences in global methylation patterning

```{r}
# normalize the data; this results in a GenomicRatioSet object
mSetSq <- preprocessQuantile(rgSet)

# create a MethylSet object from the raw data for plotting
mSetRaw <- preprocessRaw(rgSet)
# visualise what the data looks like before and after normalization
targets <- targets[match(mSetSq$Sample_Name, targets$Sample),]
par(mfrow=c(1,2))
densityPlot(rgSet, sampGroups=targets$Sample_Group,main="Raw", legend=FALSE)
densityPlot(getBeta(mSetSq), sampGroups=targets$Sample_Group,
            main="Normalized", legend=FALSE)
```

## Check for systematic differences in methylation patterning

MDS plotting reveals two distinct groups, which are revealed by labeling for different factors, to be gender

```{r}

# MDS plots to look at largest sources of variation
# first, line up targets and mSetSq
targets <- targets[match(mSetSq$Sample_Name, targets$Sample),]

par(mfrow=c(2,2))
plotMDS(getM(mSetSq), top=1000, gene.selection="common",
        col=pal[factor(targets$Sample_Group)])
legend("top", legend=levels(factor(targets$Sample_Group)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSq), top=1000, gene.selection="common",
        col=pal[factor(targets$Gender)])
legend("top", legend=levels(factor(targets$Gender)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSq), top=1000, gene.selection="common",
        col=pal[factor(targets$Ethnicity)])
legend("top", legend=levels(factor(targets$Ethnicity)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSq), top=1000, gene.selection="common",
        col=pal[factor(targets$Sample_Plate)])
legend("top", legend=levels(factor(targets$Sample_Plate)), text.col=pal,
       bg="white", cex=0.7)
```

## Remove probes that failed QC (detP), that are related to SNP variation, and have cross-reactivity/binding

```{r}

# ensure probes are in the same order in the mSetSq and detP objects
detP <- detP[match(featureNames(mSetSq),rownames(detP)),]
# remove any probes that have failed in one or more samples
keep <- rowSums(detP < 0.01) == ncol(mSetSq)
table(keep)
mSetSqFlt <- mSetSq[keep,]
mSetSqFlt

# if your data includes males and females, remove probes on the sex chromosomes
keep <- !(featureNames(mSetSqFlt) %in% ann450k$Name[ann450k$chr %in%  c("chrX","chrY")])
mSetSqFlt <- mSetSqFlt[keep,]
table(keep)

# pull in my cg sites that I'm skipping due to overlap with SNPs and 
# are cross-reactive and are on chrs X Y
cg_remove_1 <- scan('~/git/fetal_alcohol/450k_cg_sites_that_LITERALLY_are_on_SNPS.maf005_somepop_plus1bp.txt',what='character')
cg_remove_2 <- scan('~/git/fetal_alcohol/450k_cg_sites_that_overlap_dbsnp138.maf005_somepop_plus1bp.txt',what='character')
xReactive <- scan('~/git/fetal_alcohol/illumina450k_positions_to_exclude.not_including_dbsnp_overlapping.withChen.dat',what='character')
cg_remove <- c(cg_remove_1, cg_remove_2, xReactive)
cg_remove <- unique(cg_remove)

keep <- !(featureNames(mSetSqFlt) %in% cg_remove)
table(keep)
mSetSqFlt <- mSetSqFlt[keep,]           
```

## Replot MDS with probes removed

```{r}
# MDS plots to look at largest sources of variation
# now with the filtered set
# again, ensure targets and mSetSqFlt line up
targets <- targets[match(mSetSqFlt$Sample_Name, targets$Sample),]
par(mfrow=c(2,2))
plotMDS(getM(mSetSqFlt), top=1000, gene.selection="common",
        col=pal[factor(targets$Sample_Group)])
legend("top", legend=levels(factor(targets$Sample_Group)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSqFlt), top=1000, gene.selection="common",
        col=pal[factor(targets$Gender)])
legend("top", legend=levels(factor(targets$Gender)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSqFlt), top=1000, gene.selection="common",
        col=pal[factor(targets$Ethnicity)])
legend("top", legend=levels(factor(targets$Ethnicity)), text.col=pal,
       bg="white", cex=0.7)

plotMDS(getM(mSetSqFlt), top=1000, gene.selection="common",
        col=pal[factor(targets$Sample_Plate)])
legend("top", legend=levels(factor(targets$Sample_Plate)), text.col=pal,
       bg="white", cex=0.7)
```

## Calculate M-values for statistical analysis and Beta values for plotting

```{r}

# calculate M-values for statistical analysis
mVals <- getM(mSetSqFlt)
#head(mVals[,1:5])

bVals <- getBeta(mSetSqFlt)
#head(bVals[,1:5])
```

## Use limma with a linear model and eBayes for significant testing to find differentially methylated positions

The approach used in the manuscript
```{r}
# explicitly match targets sample order (rows) with mVars
targets <- targets[match(colnames(mVals), targets$Sample),]


case_control <- factor(targets$Case.Control)
ethnicity <- factor(targets$Ethnicity)
gender <- factor(targets$Gender)
#education <- as.numeric(targets$Education)
cd8t <- as.numeric(targets$CD8T)
cd4t <- as.numeric(targets$CD4T)
nk <- as.numeric(targets$NK)
mono <- as.numeric(targets$Mono)
gran <- as.numeric(targets$Gran)
smoking <- factor(targets$Smoking)

design <- model.matrix(~0+case_control+gender+cd8t+cd4t+nk+mono+gran+ethnicity, data=targets)
colnames(design)<-c("Case","Control","Gender","CD8T","CD4","NK","MONO","GRAN","Hispanic","Other","White")
cmtx <- makeContrasts( "Case-Control", levels=design)
fit <- lmFit(mVals, design)
fit2 <- contrasts.fit(fit, cmtx)
fit2 <- eBayes(fit2)
summary(decideTests(fit2))


# get the table of results for the first contrast 
ann450kSub <- ann450k[match(rownames(mVals),ann450k$Name),
                      c(1:4,12:19,24:ncol(ann450k))]
DMPs <- topTable(fit2, num=Inf, coef=1, genelist=ann450kSub)
head(DMPs)